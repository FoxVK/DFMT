\section{USB}
\label{sec:USB}
Na rozdíl od například populárního rozhraní UART je USB podstatně komplikovanější. Je to určitou daní za jeho univerzálnost. Vzhledem k velkému rozsahu specifikace USB \cite{usb-spec} se omezím pouze na popis částí nezbytných pro implementaci modulu.\\
S vydáním specifikace USB 2.0 byly předchozí specifikace označeny jako zastaralé a neměly by se používat pro nové konstrukce. Následující text se tedy týká USB 2.0 a~rychlosti full-speed.

%minimální zařízení\\


\subsection{Stručný úvod do full-speed USB 2.0}
\subsubsection{Topologie}
\InsertFigure{figures/usb-functions.eps}{100mm}{USB endpointy a funkce.}{fig:usb-functions}

TODO Obrázek s pyramidou topologie

%TODO obrázek topologie \InsertFigure{figures/usb-functions.eps}{100mm}{USB endpointy a funkce.}{fig:usb-topo}
Ačkoliv název rozhraní (Univerzální Sériová Sběrnice) napovídá, že jde o sběrnici, jedná se o zapojení typu hvězda. Přesněji, jak je vidět z obrázku \ref{fig:usb-topo}, připojená zařízení a rozbočovače tvoří strom jehož kořenem je hostitel. Tento implementuje tzv. kořenový rozbočovač (root hub), ke kterému je možné buď přímo připojit jedno zařízení a nebo rozbočovač a do něj dalších až osm zařízení/rozbočovačů. Je možné takto za sebe zřetězit až pět rozbočovačů. Celkově je možné na jeden kořenový rozbočovač připojit až 127 zařízení (včetně rozbočovačů).\\
Velkou výhodou je, že zařízení je od topologie odstíněno. Vždy se z jeho pohledu komunikuje přímo s hostem.\\
Ve specifikaci je také zohledněn fakt, že zařízení zpravidla nezastává pouze jedinou funkci. To je konec konců případ i tohoto modulu. Obsahuje dvě funkce - zvukovou kartu a \iic tunel pro komunikaci s tunery.

\subsubsection{Komunikace}

\begin{table}[!ht]
\begin{center}
\begin{tabular}{|l|c|c|c|c|}
\hline 
 & Latence & \makecell{Vyhrazená šířka\\ pásma} & \makecell{Spolehlivý\\ přenos} & Typ dat \\ 
\hline 
Isochroní přenos & Minimální & až 90\% & Ne & Proud \\ 
\hline 
Hromadný přenos & Negarantovaná & Ne & Ano & Proud \\ 
\hline 
Přenos přerušení & Minimální & až 90\% & Ano & Proud \\ 
\hline 
Řídící přenos & Negarantovaná & až 10\% & Ano & Zprávy \\ 
\hline 
\end{tabular} 
\end{center}
\caption{Druhy USB přenosů.}
\label{tab:usb-transfer-types} 
\end{table}

Aby bylo možné uspokojit nároky na přenos (transfer) dat rozdílné povahy různými funkcemi, zavádí specifikace koncové body (endpoint). Osm výstupních (OUT) pro směr z hostitele do zařízení a osm pro směr opačný (IN). Směr je vždy určován právě z pohledu hostitele. Každému bodu je možné přiřadit jeden ze čtyř druhů přenosu podle tabulky \ref{tab:usb-transfer-types}. Výjimkou je  vstupní a výstupní koncový bod nula. Tyto vždy slouží pro řídící přenosy a na rozdíl od ostatních bodů je musí podporovat všechna zařízení.
Full-speed USB podporuje čtyři druhy komunikace uvedené v tabulce \ref{tab:usb-transfer-types}.\\ 
Body nula jsou využívány jednak k inicializaci a správě vlastního zařízení, ale také můžou být využívány zároveň i funkcemi. Například popisovaný modul jej využívá pro ovládání audio funkce.
Modul dále využívá vstupní koncový bod 1 pro přenos zvuku do hostitele a potom dvojici koncových bodů 2 v obou směrech pro komunikaci s tunery viz. obrázek \ref{fig:usb-functions}.\\
Přenos vždy sestává z alespoň jedné transakce (transaction), která se dále dělí na pakety (packets). Transakce je z pohledu zařízení vždy vyřizována od počátku do konce bez přerušení jinou transakcí. Je vždy iniciována vysláním token paketu hostitelem, který takto může řídit šířku pásma přidělovanou jednotlivým zařízením na sběrnici. Token pakety mohou být podle druhu transakce následujících třech druhů:
\begin{itemize}
\item \textbf{IN} (Vstupní) - Následuje přenos ze zařízení do hostitele.
\item \textbf{OUT} (Výstupní) - Následuje přenos z hostitele do zařízení.
\item \textbf{SETUP} - Následuje řídící přenos. %TODO ověř i a doplň překlad
\end{itemize}
Za tímto paketem následuje nula nebo více paketů s daty. Aby bylo možné detekovat výpadek nebo duplikaci některého z~paketů jsou specifikovány hned dva typy paketů. A~to DATA0 a~DATA1. U izochronních transakcí se vždy posílají pakety DATA0. U ostatních transakcí se vyšle nejprve DATA0 a~poté se~tyto druhy paketů střídají nezávisle na transakcích. Znovu se~od~DATA0 začne pouze v~následujících případech:
\begin{itemize}
\item Na začátku každé řídící transakce.
\item Po následujících žádostech hostitele (bude popsáno dále):
\begin{itemize}
\item Přiřazení konfigurace.
\item Zrušení zastavení koncového bodu.
\item Nastavení rozhraní.
\end{itemize}
\end{itemize}
Za datovými pakety následuje potvrzování transakce protistranou. Izochronní přenosy potvrzování nepodporují, tudíž datovými pakety jejich transakce končí. Transkace hromadných přenosů a přenosu přerušení jsou vždy zakončeny jedním potvrzovacím (handshake) paketem.  Transkace řídících přenosů mají před potvrzovací paket vložen jeden datový paket nulové délky (zero length packet často zkracovaný ZLP), ale opačného směru než všechny předchozí datové pakety. Potvrzovací paket vždy vysílá zařízení. Má vždy jeden z následujících typů:
\begin{itemize}
\item \textbf{ACK} (Úspěch) - Úspěšné ukončení transakce.
\item \textbf{NAK} (Neúspěch) - Typicky poškozená přijímaná data a nebo častěji zařízení nemá připravena data k odeslání.
\item \textbf{STALL} (Chyba) - Zařízení takto reaguje na požadavek, který nepodporuje.
\end{itemize}
Rozdíl mezi NAK a STALL je, že po NAK potvrzení bude hostitel požadavek opakovat (počet opakování není explicitně specifikován), kdežto STALL signalizuje nemožnost vyřízení požadavku a tudíž jej opakovat nemá smysl.

Formátování a rozpoznávání paketů řeší přímo USB modul v Mikrokontroléru, není tedy nutné se jím hlouběji zabývat. Detailní popis je v kapitole 8 USB specifikace \cite{usb-spec}.


\subsubsection{Deskriptory}
USB specifikace zavádí deskriptory (descriptors). Jedná se o unifikovaný způsob jak může zařízení informovat hostitele o svých schopnostech a požadavcích. Na základě právě těchto informací může operační systém vybrat pro funkce zařízení odpovídající ovladače, řadič v hostiteli se dozví kolik dat, jak často bude přenášet po jednotlivých koncových bodech a jakou má tomuto přenosu přiřadit prioritu a podobně.\\
Při vývoji zařízení je základním rozdělením deskriptorů rozdělení podle požadavků hostitele:
\begin{itemize}
\item \textbf{Deskriptor zařízení} (Sevice descriptor) - Nejnutnější informace pro správu zařízení na~sběrnici.
\item \textbf{Deskriptory řetězců} (String dscriptors) - Pole textových řetěců a informace o dostupných lokalizacích.
\item \textbf{Deskriptory konfigurace} (Configuration descriptor) - Struktura deskriptorů s veškerými dalšími informacemi.
\end{itemize}
Popis všech deskriptorů všech možných funkcí je zcela mimo rozsah tohoto textu. Dále se omezím pouze na deskriptory a jejich hodnoty použité v modulu.


\subsubsection{Deskriptor zařízení}
\begin{table}[ht!]
\begin{center}
\begin{tabular}{|l|c|l|l|}
\hline 
Název pole & Délka & Hodnota &  \\ 
\hline
bLength & 1B & 18 & Délka deskriptoru.\\
\hline
bDescriptorType & 1B & 0x01 & Typ deskriptoru. \\
\hline
bcdUSB & 2B & 0x0200 & \makecell[l]{Verze USB specifikace implementovaná\\ zařízením. (2.0)}\\
\hline
bDeviceClass & 1B & 0x00 & \makecell[l]{Třída zařízení.0x00 znamená, že třídu\\ specifikuje každé rozhraní zvlášť.}\\
\hline
bDeviceSubClass & 1B & 0x00 & \makecell[l]{Podtřída zařízení. Pokud je bDeviceClass\\ 0x00, musí být i toto pole 0x00.}\\
\hline
bDeviceProtocol & 1B & 0x00 & \makecell[l]{Protokol zařízení. Pokud je bDeviceClass\\ 0x00, musí být i toto pole 0x00.}\\
\hline
bMaxPacketSize & 1B & 64 & \makecell[l]{Největší délka data, kterou je možné\\ odeslat koncovým bodem 0.}\\
\hline
idVendor & 2B & \VID & ID Výrobce zařízení.\\
\hline
idProduct & 2B & \PID & ID zařízení. \\
\hline
bcdDevice & 2B & 0x0100 & Verze zařízení 1.0.\\
\hline
iManufacturer & 1B & 1 & \makecell[l]{Odkaz na řetězec s názvem výrobce.} \\
\hline
iProduct & 1B & 2 & \makecell[l]{Odkaz na řetězec s názvem zařízení.} \\
\hline
iSerialNumber & 1B & 0 & \makecell[l]{Odkaz na řetězec se sériovým číslem\\ zařízení. 0 znamená nespecifikován.}\\
\hline
bNumConfigurations & 1B & 1 & Počet konfigurací zařízení.\\
\hline
\end{tabular} 
\end{center}
\caption{Deskriptor zařízení.}
\label{tab:usb-device-descriptor} 
\end{table}
%\FloatBarrier
V tabulce \ref{tab:usb-device-descriptor} je uveden deskriptor zařízení tak, jak je použit v modulu. Myslím, že popis významu  polí v tabulce je dostatečný.  Za zmínku stojí ID výrobce a zařízení. Jejich účel je stejný jak například MAC adresa síťových zařízení a to jednoznačně identifikovat druh zařízení. Oficiální cesta je požádat o přiřazení ID výrobce USB implementers fórum, což v době psaní toho textu stojí 5000 amerických dolarů \cite{usb-vid}. Výrobci programovatelných součástek s podporou USB, ale naštěstí z pravidla nabízejí možnost zdarma získat ID produktu z jejich rozsahů. Jednou z podmínek bývá nutnost použít přidělení ID  právě na jejich součástce. Pro modul jsem získat ID produktu od firmy Microchip \PID. ID výrobce je \VID.

Pole iManufacturer, iProduct a iSerialNumber nesou indexy na deskriptory textových řetězců. Všechna pole jsou nepovinná. V případě jejich vynechání se použije index s hodnotou 0. Jak napovídají názvy jednotlivých polí, je možné takto přidat popisek výrobce a zařízení ve formě lidsky čitelného textu a sériové číslo daného kusu zařízení, které může využít ovladač v hostiteli například pro načtení posledního nastavení po opětovném připojení zařízení.

\subsubsection{Deskriptory řetězců}
TODO:Tabulka se zkrácenými string deskriptory.

Deskriptory řetězců jsou organizovány jako pole indexované od nuly. Každý jeden řetězec začíná hlavičkou deskriptoru ve které je určen typ deskriptoru (0x??) a jeho celková délka v bytech. Poté následuje samotný text zakódovaný podle normy unicode, konkrétně UTF-16. Je tedy možné použití i národních znaků.\\
Jedinou výjimkou je deskriptor s indexem 0. V zařízení je možné mít více sad textů v různých jazycích. Seznam dostupných jazyků (jazykových kódu) je právě v tomto deskriptoru. Seznam těchto kódů popisuje \cite{usb-lang}. V modulu jsem se omezil pouze na angličtinu (kód 0x0409).

\subsubsection{Konfigurace zařízení}
Konfigurace zařízení je soubor deskriptorů který popisuje schopnosti zařízení a také jeho nároky na přenos popřípadě definují sady parametrů z nichž si může hostitel vybrat tu, která mu v daný okamžik nejvíce vyhovuje. Zařízení musí specifikovat minimálně jednu konfiguraci,ale také více. Hostitel potom zařízení jednu přidělí případně ji může kdykoliv změnit za jinou.\\
Každá jedna konfigurace zažíná Deskriptorem konfigurace za kterým následují deskriptory rozhraní a koncových bodů do kterých mohou být zanořeny deskriptory další. Tvoří takto stromovou strukturu. V případě mého modulu je možná pouze jediná konfigurace. Její struktura vypadá následovně:
%\FloatBarrier
\begin{enumerate}
\item Deskriptor řídícího rozhraní zvuku.
	\begin{enumerate}
	\item Deskriptor řídícího rozhraní zvuku - hlavička.
	\item Deskriptor řídícího rozhraní zvuku - vstupní terminál přijímač rádia.
	\item Deskriptor řídícího rozhraní zvuku - výstupní terminál odesílání zvuku přes USB.
	\end{enumerate}
\item Deskriptor rozhraní pro odesílání zvuku - varianta s vypnutým přenosem.
\item Deskriptor rozhraní pro odesílání zvuku - varianta se zapnutým přenosem.
	\begin{enumerate}
	\item Deskriptor rozhraní pro odesílání zvuku - obecný deskriptor.
	\item Deskriptor rozhraní pro odesílání zvuku - popis formátování dat.
	\item Deskriptor koncového bodu - odesílání zvuku.
	\end{enumerate}
\item Deskriptor rozhraní specifikovaného výrobcem - \iic tunel.
	\begin{enumerate}
	\item Deskriptor koncového bodu - odesílání dat hostu.
	\item Deskriptor koncového bodu - příjem dat z hosta.
	\end{enumerate}
\end{enumerate}
%\FloatBarrier


\subsubsection{Deskriptor konfigurace}
\begin{table}[ht!]
\begin{center}
\begin{tabular}{|l|c|l|l|}
\hline 
Název pole & Délka & Hodnota &  \\ 
\hline
bLength & 1B & 9 & Délka deskriptoru.\\
\hline
bDescriptorType & 1B & 0x02 & Typ deskriptoru. \\
\hline
wTotalLength & 2B & 127 & Celková délka všech deskriptorů konfigurace.\\
\hline
bNumInterfaces & 1B & 3 & Počet rozhraní v konfiguraci.\\
\hline
bConfigurationValue & 1B & 1 & Index této konfigurace.\\
\hline
iConfiguration & 1B & 0 & Odkaz na řetězec s popisem konfigurace.\\
\hline
bmAttributes & 1B & 0b10000000 & Bitová maska s atributy.\\
\hline
\end{tabular} 
\end{center}
\caption{Deskriptor konfigurace.}
\label{tab:usb-conf-desc} 
\end{table}
%\FloatBarrier

Jak je vidět z tabulky \ref{tab:usb-conf-desc}, tento deskriptor slouží zejména pro informace pro identifikaci konfigurace. A to zejména index iConfiguration, to je hodnota, kterou poté pošle host do zařízení v požadavku o přidělení konfigurace. Dále pak wTotalLength. Hostitel obdrží všechny případné konfigurace v jednom bloku. Na základě této hodnoty rozliší kde jednotlivé konfigurace začínají a končí.

Za zmínku také stojí pole bmAttributes. Nejvyšší bit musí být z důvodu kompatibility s USB 1.0 nastaven na 1, nejnižší bity 0-4, jsou rezervovány pro budoucí použití a musí být nastaveny na 0. Bit 6 signalizuje, že zařízení není napájeno z USB sběrnice. Bit 5 signalizuje že zařízení chce využívat mechanizmus vlastního probuzení a informování hostitele o události. Modul má oba atributy nastaveny na 0.

%TODO ref na remote wakeup

\subsubsection{USB audio 1.0}
Největší část konfigurace zabírají deskriptory popisující část přenosu zvuku. Je to dáno také tím, že specifikace USB audio \cite{usb-audio} nepopisuje pouze přenos audia po USB. Nabízí také prostředky pro popis topologie vstupů, výstupů, různých efektových jednotek přepínačů, směšovačů a podobně včetně jejich ovládání. Bylo by například možné takto realizovat kompletní ovládání mixážního pultu kde by přes usb mohlo být realizováno pouze několik vstupů a výstupů a nebo i žádný.

Topologie modulu rádia z pohledu této specifikace je nejjednodušší možná. Je zde pouze jeden výstupní terminál přenosu zvuku přes USB, který má jako vstup nastaven vstupní terminál přijímač rádia.


\begin{table}[t]
\begin{center}
\begin{tabular}{|l|c|l|l|}
\hline 
Název pole & Délka & Hodnota &  \\ 
\hline
bLength & 1B & 9 & Délka deskriptoru.\\
\hline
bDescriptorType & 1B & 0x04 & Typ deskriptoru. \\
\hline
bInterfaceNumber & 1B & 0 & Pořadové číslo rozhraní.\\
\hline
bAlternateSetting & 1B & 0 & Identifikátor alternativní nastavení.\\
\hline
bNumEndpoints & 1B & 0 & Počet koncových bodů v tomto rozhraní.\\
\hline
bInterfaceClass & 1B & 1 & Třída rozhraní. (Audio)\\
\hline
bInterfaceSubClass & 1B & 1 & Podtřída rozhraní. (Control device)\\
\hline
bInterfaceProtocol & 1B & 0 & Vždy 0. \\
\hline
iInterface & 1B & 0 & Index na textový řetězec.\\
\hline
\end{tabular} 
\end{center}
\caption{Deskriptor řídícího rozhraní zvuku.}
\label{tab:usb-aud-ctrl} 
\end{table}

\begin{table}[t]
\begin{center}
\begin{tabular}{|l|c|l|l|}
\hline 
Název pole & Délka & Hodnota &  \\ 
\hline
bLength & 1B & 9 & Délka deskriptoru.\\
\hline
bDescriptorType & 1B & 0x24 & Typ deskriptoru. \\
\hline
bDescriptorSubType & 1B & 0x01 & Pod typ deskriptoru. (Hlavička)\\
\hline
bcdADC & 2B & 0x0100 & Verze USB Audio specifikace.\\
\hline
wTotalLength & 2B & 30 & Celková délka deskriptorů tohoto rozhraní.\\
\hline
bInCollection & 1B & 1 & Počet rozhraní pro odesílání zvuku.\\
\hline
baInterfaceNr(1) & 1B & 1 & Index rozhraní pro odesílání zvuku.\\
\hline
\end{tabular}  
\end{center}
\caption{Deskriptor řídícího rozhraní zvuku - hlavička.}
\label{tab:usb-aud-ctrl-head} 
\end{table}

\clearpage

\begin{table}[t]
\begin{center}
\begin{tabular}{|l|c|l|l|}
\hline 
Název pole & Délka & Hodnota &  \\ 
\hline
bLength & 1B & 12 & Délka deskriptoru.\\
\hline
bDescriptorType & 1B & 0x24 & Typ deskriptoru. \\
\hline
bDescriptorSubType & 1B & 0x02 & Pod typ deskriptoru. (Vstupní terminál)\\
\hline
bterminalID & 1B & 1 & Identifikátor terminálu.\\
\hline
wTerminalType & 2B & 0x0710 & Typ terminálu. (Přijímač rádia)\\
\hline
bAssocTerminal & 1B & 0 & Přidružený terminál. (Nejedná se o zvukové propojení)\\
\hline
bNrChannels & 1B & 2 & Počet zvukových kanálů.\\
\hline
wChannelConfig & 2B & 0x0003 & Bitová mapa konfigurace kanálů.\\
\hline
iChannelNames & 1B & 0 & Index na textový řetězec s názvem kanálů.\\
\hline
iTerminal & 1B & 0 & Index na textový řetězec s popisem terminálu.\\
\hline
\end{tabular}  
\end{center}
\caption{Deskriptor řídícího rozhraní zvuku - vstupní terminál.}
\label{tab:usb-aud-ctrl-in} 
\end{table}

\begin{table}[t]
\begin{center}
\begin{tabular}{|l|c|l|l|}
\hline 
Název pole & Délka & Hodnota &  \\ 
\hline
bLength & 1B & 9 & Délka deskriptoru.\\
\hline
bDescriptorType & 1B & 0x24 & Typ deskriptoru. \\
\hline
bDescriptorSubType & 1B & 0x03 & Pod typ deskriptoru. (Výstupní terminál)\\
\hline
bterminalID & 1B & 2 & Identifikátor terminálu.\\
\hline
wTerminalType & 2B & 0x0101 & Typ terminálu. (Odesílání přes USB)\\
\hline
bAssocTerminal & 1B & 0 & Přidružený terminál. (Nejedná se o zvukové propojení)\\
\hline
bSourceID & 1B & 1 & Identifikátor připojeného vstupního terminálu. \\
\hline
iTerminal & 1B & 0 & Index na textový řetězec s popisem terminálu.\\
\hline
\end{tabular}  

\end{center}
\caption{Deskriptor řídícího rozhraní zvuku - výstupní terminál.}
\label{tab:usb-aud-ctrl-out} 
\end{table}
\FloatBarrier

Řízení probíhá přes řídící rozhraní zvuku (Audio control interface), které je vždy napojeno na koncový bod 0.  V popisu tohoto rozhraní se skrývá i topologie. Skládá se z deskriptorů v tabulkách \ref{tab:usb-aud-ctrl}, \ref{tab:usb-aud-ctrl-head}, \ref{tab:usb-aud-ctrl-in} a \ref{tab:usb-aud-ctrl-out}.

První deskriptor pouze určuje, že bude následovat popis rozhraní řízení zvuku třídy audio.

Následující deskriptor  (tabulka \ref{tab:usb-aud-ctrl-head}) tvoří hlavičku třídně specifického popisu rozhraní. Specifikuje jednak použitou verzi USB Audio specifikace a také seznam rozhraní pro odesílání zvuku přes USB. Počet položek v tomto seznamu určuje hodnota pole bInCollection. Poté se na konec deskriptoru pro každé rozhraní přidá jedna položka. V tomto případě je použito pouze jediné rozhraní.

Zbylá dvojice deskriptorů (tabulka \ref{tab:usb-aud-ctrl-in} a \ref{tab:usb-aud-ctrl-out}) popisuje vlastní topologii. Výstupní terminály mají vždy pole bSourceID, které se nastaví na hodnotu bTerminalType vstupního terminálu se kterým je propojen.

% v popsat idiotský bassoc
% přidat dokument s terminal typama

\begin{table}[ht!]
\begin{center}
\begin{tabular}{|l|c|l|l|}
\hline 
Název pole & Délka & Hodnota &  \\ 
\hline
bLength & 1B & 9 & Délka deskriptoru.\\
\hline
bDescriptorType & 1B & 0x04 & Typ deskriptoru. \\
\hline
bInterfaceNumber & 1B & 1 & Pořadové číslo rozhraní.\\
\hline
bAlternateSetting & 1B & 0 & Identifikátor alternativní nastavení.\\
\hline
bNumEndpoints & 1B & 0 & Počet koncových bodů v tomto rozhraní.\\
\hline
bInterfaceClass & 1B & 1 & Třída rozhraní. (Audio)\\
\hline
bInterfaceSubClass & 1B & 2 & Podtřída rozhraní. (Streaming)\\
\hline
bInterfaceProtocol & 1B & 0 & Vždy 0. \\
\hline
iInterface & 1B & 0 & Index na textový řetězec.\\
\hline
\end{tabular} 
\end{center}
\caption{Deskriptor rozhraní odesílání zvuku.}
\label{tab:usb-aud-snd-0} 
\end{table}


\begin{table}[ht!]
\begin{center}
\begin{tabular}{|l|c|l|l|}
\hline 
Název pole & Délka & Hodnota &  \\ 
\hline
bLength & 1B & 9 & Délka deskriptoru.\\
\hline
bDescriptorType & 1B & 0x04 & Typ deskriptoru. \\
\hline
bInterfaceNumber & 1B & 1 & Pořadové číslo rozhraní.\\
\hline
bAlternateSetting & 1B & 1 & Identifikátor alternativní nastavení.\\
\hline
bNumEndpoints & 1B & 1 & Počet koncových bodů v tomto rozhraní.\\
\hline
bInterfaceClass & 1B & 1 & Třída rozhraní. (Audio)\\
\hline
bInterfaceSubClass & 1B & 2 & Podtřída rozhraní. (Streaming)\\
\hline
bInterfaceProtocol & 1B & 0 & Vždy 0. \\
\hline
iInterface & 1B & 0 & Index na textový řetězec.\\
\hline
\end{tabular} 
\end{center}
\caption{Deskriptor rozhraní odesílání zvuku.}
\label{tab:usb-aud-snd} 
\end{table}

Dále následuje sada deskriptorů popisující rozhraní pro odesílání zvuku (audio streaming interface). Stejně jako řídící rozhraní zde se začíná standardním  deskriptorem rozhraní, který nese základní informace o rozhraní.

V tomto případě jsou použity hned dva deskriptory (tabulka \ref{tab:usb-aud-snd-0} a \ref{tab:usb-aud-snd}). Liší se pouze ve dvou polích a to   bAlternateSetting a bNumEndpoints. Druhé z těchto polí určuje počet koncových bodů použitých v rozhraní. Díky tomu, že je v prvním deskriptoru tento počet nulový, má host možnost zvolit toto alternativní nastavení vždy když nemá zájem o zvuková data. K identifikaci tohoto nastavení slouží hodnota v prvním ze  zmíněných polí bAlternateSettings.

\begin{table}[ht!]
\begin{center}
\begin{tabular}{|l|c|l|l|}
\hline 
Název pole & Délka & Hodnota &  \\ 
\hline
bLength & 1B & 7 & Délka deskriptoru.\\
\hline
bDescriptorType & 1B & 0x24 & Typ deskriptoru. \\
\hline
bDescriptorSubType & 1B & 1 & Podtyp deskriptoru. \\
\hline
bTerminalLink & 1B & 2 & Index výstupního terminálu.\\ 
\hline
bDelay & 1B & 1 & Zpoždění v paketech.\\ 
\hline
wFormatTag & 2B & 1 & Formát přenášených dat. (PCM)\\ 
\hline
\end{tabular} 
\end{center}
\caption{Deskriptor formátu zvuku - hlavička.}
\label{tab:usb-aud-snd-fmt-head} 
\end{table}

\begin{table}[ht!]
\begin{center}
\begin{tabular}{|l|c|l|l|}
\hline 
Název pole & Délka & Hodnota &  \\ 
\hline
bLength & 1B & 11 & Délka deskriptoru.\\
\hline
bDescriptorType & 1B & 0x24 & Typ deskriptoru. \\
\hline
bDescriptorSubType & 1B & 2 & Podtyp deskriptoru. \\
\hline
bFormatType & 1B & 1 & Typ formátu.\\
\hline
bNrChannels & 1B & 2 & Počet kanálů.\\
\hline
bSubFrameSize & 1B & 2 & Velikost jednoho pod-rámce v bytech. \\ %TODO vysvětli jak je to se zaokrohlováním
\hline
bSubFrameResolution & 1B & 16 & Počet platných bitů jednoho pod-rámce. \\
\hline 
bSamFreqType & 1B & 1 & Způsob určení vzorkovací frekvence. (Diskrétní) \\ %TODO popis diskretni a spojite frekvence
\hline
tSamFreq(1) & 3B & 48000 & Vzorkovací frekvence v Hz. \\
\hline 
\end{tabular} 
\end{center}
\caption{Deskriptor formátu zvuku.}
\label{tab:usb-aud-snd-fmt} 
\end{table}

\FloatBarrier

V tabulce \ref{tab:usb-aud-snd-fmt-head} a \ref{tab:usb-aud-snd-fmt} jsou deskriptory popisující formátování a způsob přenosu zvukových dat. Formátování dat je specifikováno v \cite{usb-audio-formats}. Podle tohoto dokumentu se proud zvukových dat dělí do paketů, které se odesílají každou 1 ms. Paket je složen z rámců (frames), které reprezentují úrovně všech kanálů zachycených v jeden okamžik. Samotné úrovně jednotlivých kanálů se nazývají pod-rámce (subframes).

Deskriptor třídně specifické hlavičky v tabulce \ref{tab:usb-aud-snd-fmt-head} nese kromě poli pro identifikaci sebe sama pouze tři zajímavá pole. 

První je bTerminalLink. Identifikuje ke kterému výstupnímu terminálu se popis formátu formát vztahuje. 

Pole bDelay je hodnota prodlevy mezi zachycením vzorku a jeho odesláním. Veličinou je počet paketů. Hodnota tohoto pole má význam pouze v případe simultánního záznamu zvuku z více zvukových karet a podobně. V případě přijímače rádia na ní nezáleží. 

Posledním polem je wFormatTag, které určuje, že hodnoty jednotlivých vzorků budou ve formátu PCM jako  čísla se znaménkem. I zde nabízí USB Audio specifikace značnou volnost a kromě formátu PCM je možné přenášet zvuk komprimovaný různými kodeky. Detailnější specifikace je v \cite{usb-audio-formats}. 

Následující deskriptor, vyobrazený v tabulce \ref{tab:usb-aud-snd-fmt}, blíže specifikuje parametry PCM formátu. Toto specifikuje hodnota pole bFormatType.

Pole určuje, jak název napovídá, bNrChannels určuje počet kanálů. Pole bSubframeSize určuje velikost jednoho pod-rámce (vzorku) v Bytech. Zároveň pole bSubFrameResolution určuje počet platných bitů v pod-rámci.

Konec deskriptoru je věnován specifikaci vzorkovacích frekvencí. Pomocí hodnoty v poli bSamFreqType se určí způsob specifikace frekvencí. V případě modulu je použita pouze jediná diskrétní frekvence, která je specifikována v poli tSamFreq(1). Je možné zde specifikovat více diskrétních frekvencí, ze kterých si poté hostitel vybírá a nebo specifikovat interval.


\begin{table}[ht!]
\begin{center}
\begin{tabular}{|l|c|l|l|}
\hline 
Název pole & Délka & Hodnota &  \\ 
\hline
bLength & 1B & 7 & Délka deskriptoru.\\
\hline
bDescriptorType & 1B & 0x25 & Typ deskriptoru. \\
\hline
bEndpointAddress & 1B & 0x81 & Číslo koncového bodu. \\
\hline
bmAttributes & 1B & 0b00000001 & Bitová mapa s atributy.\\ %TODO
\hline
wMaxPacketSize & 2B & 384 & Maximální velikost paketu v bytech.\\ %TODO jak se ktomu dojde
\hline
bInterval & 1B & 1 & Interval Odesílání. \\ %TODO vysvětli 
\hline
bRefresh & 1B & 0 & Frekvence synchronizace. (nepoužito) \\
\hline 
bSynchAddress & 1B & 0 & Adresa synchronizačního koncového bodu. (Nepoužito) \\ %TODO kap 
\hline
\end{tabular} 
\end{center}
\caption{Deskriptor koncového bodu odesílání zvuku.}
\label{tab:usb-aud-snd-ep} 
\end{table}

V tabulce \ref{tab:usb-aud-snd-ep} je deskriptor koncového bodu popisující koncový bod odesílání zvuku (audio streaming endpoint). Prvním zajímavým polem je adresa koncového bodu v poli bEndpointAddress. Jako adresa je použito číslo koncového bodu s tím, že v případě vstupního koncového bodu (směr do hostitele) se sedmý (nejvyšší) bit nastaví na 1. U opačného směru tento bit zůstává nulový.

Pole bmAttributes obsahuje bitovou mapu atributů koncového bodu. Význam bitů 0 a 1 je následující:
\begin{itemize}
\item 00 - Řídící koncový bod
\item 01 - Izochronní koncový bod
\item 10 - Hromadný koncový bod
\item 11 - Koncový bod přerušení
\end{itemize}
Zbylé bity popisují způsob synchronizace izochronních koncových bodů, která ale není použita. Jejich popis je v kapitole  5.12.4 USB specifikace \cite{usb-spec}.


Pole wMaxPacket size určuje největší možnou velikost paketu. V tomto případě se spočítá z deskriptoru v tabulce \ref{tab:usb-aud-snd-fmt} jako $ bNrChannels \cdot bSubFrameSize \cdot \frac{tSamFreq(1)}{1000} $ Vypočtenou hodnotu je nutné vždy zaokrouhlit nahoru. Například v případě vzrkovací frekvence 44,1 kHz bude ve většině paketů 44 rámců, ale každý desátý jich bude mít 45.

Pole bInterval určuje periodu čtení dat z koncového bodu. Hodnota 1 znamená, že se bude hostitel pokoušet číst data z koncového bodu každou 1 ms. Zbývající dvě pole se vztahují k synchronizaci, která nebyla použita a tudíž jsou nastavena na hodnotu 0.

\begin{table}[ht!]
\begin{center}
\begin{tabular}{|l|c|l|l|}
\hline 
Název pole & Délka & Hodnota &  \\ 
\hline
bLength & 1B & 9 & Délka deskriptoru.\\
\hline
bDescriptorType & 1B & 0x05 & Typ deskriptoru. \\
\hline
bDescriptorSubType & 1B & 1 & Podtyp deskriptoru. \\
\hline
bmAttributes & 1B & 0b00000000 & Bitová mapa s atributy.\\ %TODO
\hline
bLockDelayUnits & 1B & 0 & Jednotky prodlevy stabilizace synchronizace. (Nepoužito).\\ %TODO 
\hline
wLockDelay & 2B & 0 & Doba prodlevy stabilizace synchronizace. (Nepoužito) \\ %TODO vysvětli 
\hline
\end{tabular} 
\end{center}
\caption{Deskriptor koncového bodu odesílání zvuku specifický pro danou třídu.}
\label{tab:usb-aud-snd-ep-spec} 
\end{table}

Posledním deskriptorem popisujícím přenos zvuku je třídně specifický deskriptor koncového bodu v tabulce \ref{tab:usb-aud-snd-ep-spec}. Za běžnými uvozujícími poli se nachází bitová mapa s atributy bmAttributes. Význam bitů je následující:
\begin{itemize}
\item Bit 0 - Koncový bod podporuje žádost o počáteční nastavení vzorkovacího frekvence.
\item Bit 1 - Koncový bod podporuje dynamickou změnu vzorkovací frekvence za běhu.
\item Bit 2-6 - Vyhrazeno - musí být nulové.
\item Bit 7 - Pokud je nastaveno musí se přenášená data vždy doplnit nulami, tak aby měl každý paket velikost wMaxPacketSize.
\end{itemize}

Dvě pole na konci deskriptoru umožňují specifikovat dobu potřebnou pro stabilizaci synchronizace. Synchronizace koncového bodu není použita takže obě hodnoty jsou nulové.

\clearpage



\subsubsection{Toto asi vyhodit...}
%formát deskriptoru v mcu
Deskriptory jsou binární struktury takže je nutné vzít v potaz endianitu. U USB je to vždy little-endian, to znamená, že se čílo odesílá od nejméně významného bytu po nejvíce významný. Například 0x1234 se přenese nejdříve 0x34 a poté 0x12. Mikrokontrolér PIC32 s dodáveným kompilátor XC32 používá taktéž little-endian, je z hlediska případné přenositelnosti výhodné implementovat jako pole typu \InlCode{char} viz ukázka \ref{lst:usb-dev-desc}.
\begin{lstlisting}[caption=Deskriptor zařízení.]
const static Usb_descriptor_device usb_desc_device =
{
    .bLength            = sizeof(Usb_descriptor_device),
    .bDescriptorType    = USB_DSC_DEVICE,
    .bcdUSB             = 0x0200, //2.0
    .bDeviceClass       = 0x00,
    .bDeviceSubClass    = 0x00,
    .bDeviceProtocol    = 0x00,
    .bMaxPacketSize0    = 64,
    .idVendor           = USB_VID,
    .idProduct          = USB_PID,
    .bcdDevice          = 0x0003,
    .iManufacturer      = 1,
    .iProduct           = 2,
    .iSerialNumber      = 0,
    .bNumConfigurations = 1
};
\end{lstlisting}
\label{lst:usb-dev-desc}




\subsection{Microchip Harmony framework}

TODO:
\begin{itemize}
\item Odkaz a bug se špatnou inicializací a následném dělení nulou.
\item Popsat chybu kdy nedojde k povolení AS EP na žádost set alt setting 1
\item Popsat žádost a potom iplementací přes vendor EP
\item Zminit že jsem došel k té semé chybě když jsem s senaži povolovat EP sám.
\item zmínit že s trvale povoleným EP to funguje ale přenese se pouze každý druhý paket. a doplnit screenchotem z analyzéru
\end{itemize}

\subsection{Vlastní implementace}

TODO:
\begin{itemize}
\item Popsat žádosti nutné pro konfiguraci a běh
\item zmínit ping-pong buffery a rozhraní MCU pro USB
\item Popsat rozhraní vzniklého USB stacku ??
\end{itemize}

\subsection{USB \iic tunel}

TODO:
\begin{itemize}
\item základní filozofie - vendor interface, 2x bulk EP
\item popsat formáty zpráv pro oba směry (zmínit endianitu)
\item chyby v křemíku - problém možného dvojí zápisu po návratu z přerušení a nefunčnost dvou pinů při zapnutí \iic modulu.
\end{itemize}

% zmínit chyby v křemíku (nefunkčnost pinu, a problém dvojího zápisu po přerušení)

\subsection{Omezení}

TODO
\begin{itemize}
\item Nemožnost dostat se v suspendu do 0,5 mA
\item Test mód neimplementován. Nutný pouze pro získání USB loga.
\end{itemize}
%suspend a test mod